<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Birdie Golf Bill Split Tool</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; background: #f8f9fa; }
    h2 { color: #228B22; }
    .hidden { display: none; }
    .result { margin-top: 20px; font-weight: bold; white-space: pre-line; }
    input, select { margin: 5px; padding: 5px; border-radius: 5px; border: 1px solid #ccc; width: 80px; }
    button { margin: 5px; padding: 6px 14px; cursor: pointer; border-radius: 5px; background: #228B22; color: white; border: none; }
    button:hover { background: #1e7b1e; }
    .person-block { background: #fff; border: 1px solid #ddd; padding: 10px; margin-top: 10px; border-radius: 8px; }
    ul { list-style-type: none; padding: 0; }
    li { margin: 5px 0; }
    hr { margin: 20px 0; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    th { background-color: #e9ecef; }
  </style>
</head>
<body>
  <h2>Birdie Golf Bill Split Tool</h2>

  <!-- Step 1 -->
  <div id="step1">
    <h3>Step 1: Choose Split Method</h3>
    <button onclick="chooseMode('A')">Method A: Split by Headcount</button>
    <button onclick="chooseMode('B')">Method B: Shared Bay Fee + Individual Consumption</button>
  </div>
  <hr>

  <!-- Step 2-A -->
  <div id="modeA" class="hidden">
    <h3>Method A → Split by Headcount</h3>
    <label>Total Bill (CAD): <input type="number" id="a_total" step="0.01"></label>
    <label>Number of People: <input type="number" id="a_people"></label>
    <br>
    <button onclick="calculateModeA()">Calculate</button>
    <button onclick="goBack()">Back to Step 1</button>
    <div id="a_result" class="result"></div>
  </div>

  <!-- Step 2-B -->
  <div id="modeB" class="hidden">
    <h3>Method B → Shared Bay Fee + Individual Consumption</h3>
    <label>Bay Fee Input (can enter formula, e.g., 100+20+20-10): 
      <input type="text" id="bay_fee_expr" placeholder="100+20+20-10">
    </label>
    <button onclick="calculateBayFeeExpression()">Calculate Total</button>
    <div id="b_bay_display" class="result"></div>

    <div id="split_people_input" class="hidden">
      <label>Number of Paying Customers: <input type="number" id="split_people" min="1" value="1"></label>
      <button onclick="createSplitPeople()">Confirm</button>
    </div>

    <div id="people_inputs"></div>
    <button onclick="clearPeople()">Clear Customers</button>
    <button onclick="goBack()">Back to Step 1</button>
    <button onclick="calculateModeB()">Calculate Bill</button>
    <div id="b_result" class="result"></div>
  </div>

  <script>
    let splitMode = null;
    let bayFeeTaxed = 0;
    let bayFeePreTax = 0;

    function chooseMode(mode) {
      splitMode = mode;
      document.getElementById("step1").classList.add("hidden");
      document.getElementById("modeA").classList.add("hidden");
      document.getElementById("modeB").classList.add("hidden");
      if (mode === "A") document.getElementById("modeA").classList.remove("hidden");
      if (mode === "B") document.getElementById("modeB").classList.remove("hidden");
    }

    function goBack() {
      document.getElementById("modeA").classList.add("hidden");
      document.getElementById("modeB").classList.add("hidden");
      document.getElementById("step1").classList.remove("hidden");
      clearPeople();
    }

    // --- Method A ---
    function calculateModeA() {
      let total = parseFloat(document.getElementById("a_total").value);
      let people = parseInt(document.getElementById("a_people").value);
      if (isNaN(total) || isNaN(people) || people <= 0) {
        document.getElementById("a_result").innerText = "Please enter valid total bill and number of people!";
        return;
      }
      let perPerson = total / people;
      let perPersonWithFee = perPerson * 1.02;
      document.getElementById("a_result").innerText =
        `Total Bill: CAD ${total.toFixed(2)}\n` +
        `Per Person (without processing fee): CAD ${perPerson.toFixed(2)}\n` +
        `Per Person (with 2% processing fee): CAD ${perPersonWithFee.toFixed(2)}`;
    }

    // --- Method B Bay Fee Calculation ---
    function calculateBayFeeExpression() {
      let expr = document.getElementById("bay_fee_expr").value;
      let total = 0;
      try {
        total = Function('"use strict";return (' + expr + ')')();
        if (isNaN(total)) throw "Error";
        if (total < 0) total = 0;
      } catch(e) {
        alert("Please enter a valid formula, e.g., 100+20+20-10");
        return;
      }
      bayFeePreTax = total;
      bayFeeTaxed = total * 1.05; // add 5% tax
      document.getElementById("b_bay_display").innerText = 
          `Bay Fee (pre-tax): CAD ${bayFeePreTax.toFixed(2)}\nBay Fee (with 5% tax): CAD ${bayFeeTaxed.toFixed(2)}`;
      document.getElementById("split_people_input").classList.remove("hidden");
    }

    // --- Create Split Customers ---
    function createSplitPeople() {
      let n = parseInt(document.getElementById("split_people").value);
      if (isNaN(n) || n <= 0) { alert("Please enter a valid number!"); return; }
      clearPeople();
      let container = document.getElementById("people_inputs");
      for (let i = 1; i <= n; i++) {
        let div = document.createElement("div");
        div.className = "person-block";
        div.innerHTML = `
          <h4>Customer ${i}</h4>
          <button onclick="addItem(this)">Add Item</button>
          <ul></ul>
        `;
        container.appendChild(div);
      }
    }

    function addItem(button) {
      let container = button.parentElement.querySelector("ul");
      let li = document.createElement("li");
      li.innerHTML = `
        Name: <input type="text" placeholder="Item Name">
        Unit Price (pre-tax): <input type="number" step="0.01" class="item-price">
        Quantity: <input type="number" step="1" class="item-qty" value="1">
        Type:
        <select class="item-type">
          <option value="alcohol">Alcohol (15%)</option>
          <option value="drink">Drink (12%)</option>
          <option value="food">Food/Water (5%)</option>
        </select>
        <button onclick="this.parentElement.remove()">Delete</button>
      `;
      container.appendChild(li);
    }

    function clearPeople() {
      document.getElementById("people_inputs").innerHTML = "";
      document.getElementById("b_result").innerHTML = "";
    }

    function getTaxRate(type) {
      if (type === "alcohol") return 0.15;
      if (type === "drink") return 0.12;
      if (type === "food") return 0.05;
      return 0;
    }

    // --- Method B Calculate ---
    function calculateModeB() {
      let peopleBlocks = document.getElementsByClassName("person-block");
      if (peopleBlocks.length === 0) { alert("Please add customers first!"); return; }

      let n = peopleBlocks.length;
      let baySharePerPerson = bayFeeTaxed / n;

      let output = "<h4>Bill Details</h4><table><tr><th>Customer</th><th>Bay Fee (CAD)</th><th>Consumption (CAD)</th><th>Total (CAD)</th><th>With 2% Fee (CAD)</th></tr>";
      let grandTotal = 0;

      for (let i = 0; i < n; i++) {
        let block = peopleBlocks[i];
        let bayShare = baySharePerPerson;

        let items = block.querySelectorAll("li");
        let consumption = 0;
        items.forEach(item => {
          let price = parseFloat(item.querySelector(".item-price").value) || 0;
          let qty = parseInt(item.querySelector(".item-qty").value) || 1;
          let type = item.querySelector(".item-type").value;
          consumption += price * qty * (1 + getTaxRate(type));
        });

        let total = bayShare + consumption;
        let totalWithFee = total * 1.02;
        grandTotal += total;

        output += `<tr>
          <td>Customer ${i+1}</td>
          <td>${bayShare.toFixed(2)}</td>
          <td>${consumption.toFixed(2)}</td>
          <td>${total.toFixed(2)}</td>
          <td>${totalWithFee.toFixed(2)}</td>
        </tr>`;
      }

      output += `</table><p><strong>Total Bill (without 2% fee): CAD ${grandTotal.toFixed(2)}</strong></p>`;
      document.getElementById("b_result").innerHTML = output;
    }
  </script>
</body>
</html>
